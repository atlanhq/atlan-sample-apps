name: E2E Application Test
permissions:
  contents: read
on:
  push:
    branches:
      - main
      - e2e
  pull_request:
    types: [labeled, reopened, synchronize, opened]

jobs:
  test:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: ${{ startsWith(github.ref, 'refs/pull/') }}
    timeout-minutes: 30
    if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/e2e' || (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'e2e-test')) }}
    strategy:
      matrix:
        app:
          - name: hello_world
            path: quickstart/hello_world
            application_name: hello-world
          - name: polyglot
            path: quickstart/polyglot
            application_name: polyglot

    steps:
      - uses: actions/checkout@v4.0.0

      # Install Dapr
      - name: Install Dapr CLI
        run: |
          wget -q https://raw.githubusercontent.com/dapr/cli/master/install/install.sh -O - | /bin/bash -s 1.16.2
          dapr init --runtime-version 1.16.0 --slim

      # Install Temporal
      - name: Install Temporal CLI and Start Server
        run: |
          curl -sSf https://temporal.download/cli.sh | sh
          export PATH="$HOME/.temporalio/bin:$PATH"
          temporal server start-dev --db-filename /tmp/temporal-${{ matrix.app.name }}.db &
          sleep 5

      # Setup Python and uv
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "0.7.3"

      # Sync dependencies in app directory
      - name: Sync dependencies
        working-directory: ${{ matrix.app.path }}
        run: |
          uv sync --all-extras --all-groups
          # Install scalene if not already available
          uv pip install scalene || echo "Scalene already installed or installation failed"

      # Build Java JAR for polyglot (if needed)
      - name: Build Java JAR for polyglot
        if: matrix.app.name == 'polyglot'
        working-directory: ${{ matrix.app.path }}
        run: |
          uv run poe build-java || echo "Java build not required or failed"

      # Download components and start dapr and temporal services
      - name: Start Platform Services
        working-directory: ${{ matrix.app.path }}
        run: |
          uv run poe download-components
          uv run poe start-deps
          # Wait for Dapr to be ready
          echo "Waiting for Dapr to be ready..."
          for i in {1..30}; do
            if curl -f http://localhost:3500/v1.0/healthz > /dev/null 2>&1; then
              echo "Dapr is ready"
              break
            fi
            echo "Waiting for Dapr... ($i/30)"
            sleep 2
          done
          # Wait for Temporal to be ready
          export PATH="$HOME/.temporalio/bin:$PATH"
          echo "Waiting for Temporal to be ready..."
          for i in {1..30}; do
            if temporal operator cluster describe > /dev/null 2>&1; then
              echo "Temporal is ready"
              break
            fi
            echo "Waiting for Temporal... ($i/30)"
            sleep 2
          done

      # Start the application with scalene profiling
      - name: Start the application
        id: start_app
        working-directory: ${{ matrix.app.path }}
        env:
          ATLAN_LOCAL_DEVELOPMENT: true
          ATLAN_APPLICATION_NAME: ${{ matrix.app.application_name }}
        run: |
          export PATH="$HOME/.temporalio/bin:$PATH"
          # Create .github directory if it doesn't exist
          mkdir -p .github
          # Start the application with scalene profiling
          uv run scalene --profile-all --cli --outfile ./.github/scalene-${{ matrix.app.name }}.json --json main.py > app.log 2>&1 &
          APP_PID=$!
          echo "app_pid=$APP_PID" >> $GITHUB_OUTPUT
          echo "Started application with PID: $APP_PID"

          # Wait for application to start with health check
          APP_READY=false
          for i in {1..60}; do
            # Check if process is still running
            if ! kill -0 $APP_PID 2>/dev/null; then
              echo "Application process died. Checking logs:"
              cat app.log || true
              exit 1
            fi

            # Check if health endpoint is responding
            if curl -f http://localhost:8000/server/health > /dev/null 2>&1; then
              echo "Application is ready!"
              APP_READY=true
              break
            fi
            echo "Waiting for application to start... ($i/60)"
            sleep 2
          done

          if [ "$APP_READY" = "false" ]; then
            echo "Application failed to start. Logs:"
            cat app.log || true
            echo "Checking if port 8000 is in use:"
            lsof -i :8000 || true
            exit 1
          fi

          # Verify app is still running
          if ! kill -0 $APP_PID 2>/dev/null; then
            echo "Application died after starting. Logs:"
            cat app.log || true
            exit 1
          fi

      # Verify app is still running before tests
      - name: Verify application is running
        working-directory: ${{ matrix.app.path }}
        run: |
          APP_PID=${{ steps.start_app.outputs.app_pid }}
          if ! kill -0 $APP_PID 2>/dev/null; then
            echo "Application is not running. Checking logs:"
            cat app.log || true
            exit 1
          fi
          # Verify health endpoint
          if ! curl -f http://localhost:8000/server/health > /dev/null 2>&1; then
            echo "Application health check failed. Checking logs:"
            cat app.log || true
            exit 1
          fi
          echo "Application is running and healthy"

      # Run E2E tests
      - name: Run E2E tests
        working-directory: ${{ matrix.app.path }}
        env:
          ATLAN_LOCAL_DEVELOPMENT: true
          ATLAN_APPLICATION_NAME: ${{ matrix.app.application_name }}
        run: |
          export PATH="$HOME/.temporalio/bin:$PATH"
          uv run pytest tests/e2e -v --tb=short || TEST_EXIT_CODE=$?
          # If tests fail, show app logs
          if [ -n "${TEST_EXIT_CODE:-}" ]; then
            echo "Tests failed. Application logs:"
            cat app.log || true
            exit $TEST_EXIT_CODE
          fi

      # Collect scalene metrics and generate report
      - name: Get scalene metrics and output
        working-directory: ${{ matrix.app.path }}
        if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/e2e' || contains(github.event.pull_request.labels.*.name, 'e2e-test') }}
        run: |
          export PATH="$HOME/.temporalio/bin:$PATH"
          # Kill the application to finalize scalene profiling
          APP_PID=${{ steps.start_app.outputs.app_pid }}
          if [ -n "$APP_PID" ]; then
            kill $APP_PID 2>/dev/null || true
            sleep 5
          fi

          SCALENE_FILE=".github/scalene-${{ matrix.app.name }}.json"

          # First calculate metrics from current run's scalene.json
          if [ -f "$SCALENE_FILE" ]; then
            # Calculate Average CPU Usage upto 2 decimal places
            AVG_CPU=$(jq -r '
              [
                .files |
                to_entries[] |
                .value.functions[] |
                select(.n_cpu_percent_c != null and .n_cpu_percent_python != null and .n_sys_percent != null) |
                (.n_cpu_percent_c + .n_cpu_percent_python + .n_sys_percent)
              ] |
              add / length
            ' "$SCALENE_FILE" 2>/dev/null | awk '{printf "%.2f\n", $1}' || echo "N/A")

            # Max CPU Usage upto 2 decimal places
            MAX_CPU=$(jq -r '
              .files |
              to_entries[] |
              .value.functions[] |
              select(.n_cpu_percent_c != null and .n_cpu_percent_python != null and .n_sys_percent != null) |
              (.n_cpu_percent_c + .n_cpu_percent_python + .n_sys_percent)
            ' "$SCALENE_FILE" 2>/dev/null | sort -rn | head -n1 | awk '{printf "%.2f\n", $1}' || echo "N/A")

            MEMORY_USAGE=$(jq -r '
              .max_footprint_mb
            ' "$SCALENE_FILE" 2>/dev/null | awk '{printf "%.2f\n", $1}' || echo "N/A")
          else
            echo "Current scalene.json does not exist"
            AVG_CPU="N/A"
            MAX_CPU="N/A"
            MEMORY_USAGE="N/A"
          fi

          # Now fetch Main branch and calculate its metrics
          git fetch origin main
          MAIN_SCALENE_FILE=".github/scalene-${{ matrix.app.name }}.json"
          if git cat-file -e origin/main:${{ matrix.app.path }}/$MAIN_SCALENE_FILE 2>/dev/null && \
              git show origin/main:${{ matrix.app.path }}/$MAIN_SCALENE_FILE > main_scalene.json; then
            # Calculate metrics for the main branch
            MAIN_AVG_CPU=$(jq -r '
              [
                .files |
                to_entries[] |
                .value.functions[] |
                select(.n_cpu_percent_c != null and .n_cpu_percent_python != null and .n_sys_percent != null) |
                (.n_cpu_percent_c + .n_cpu_percent_python + .n_sys_percent)
              ] |
              add / length
            ' main_scalene.json 2>/dev/null | awk '{printf "%.2f\n", $1}' || echo "N/A")

            MAIN_MAX_CPU=$(jq -r '
              .files |
              to_entries[] |
              .value.functions[] |
              select(.n_cpu_percent_c != null and .n_cpu_percent_python != null and .n_sys_percent != null) |
              (.n_cpu_percent_c + .n_cpu_percent_python + .n_sys_percent)
            ' main_scalene.json 2>/dev/null | sort -rn | head -n1 | awk '{printf "%.2f\n", $1}' || echo "N/A")

            MAIN_MEMORY_USAGE=$(jq -r '
              .max_footprint_mb
            ' main_scalene.json 2>/dev/null | awk '{printf "%.2f\n", $1}' || echo "N/A")
          else
            echo "$MAIN_SCALENE_FILE does not exist in the main branch"
            MAIN_AVG_CPU="N/A"
            MAIN_MAX_CPU="N/A"
            MAIN_MEMORY_USAGE="N/A"
          fi

          # Generate comprehensive report
          echo "## ðŸ“Š ${{ matrix.app.name }} App E2E Test Results and Performance Metrics" >> metrics.md
          echo "### Runner Environment Details" >> metrics.md
          echo "$(mpstat 1 1 | awk 'NR == 1')" >> metrics.md
          echo "Total Memory: $(free -m | awk 'NR == 2 {print $2}')" MB >> metrics.md

          echo "### ðŸŽ¯ Test Summary" >> metrics.md
          echo "| Metric | Value |" >> metrics.md
          echo "|--------|-------|" >> metrics.md
          echo "| App | ${{ matrix.app.name }} |" >> metrics.md
          echo "| Status | âœ… Tests Passed |" >> metrics.md

          # Update metrics report to include both current and main branch summaries
          echo "## ðŸ“Š Performance Usage Summary" >> metrics.md
          echo "| Metric | Current Branch | Main Branch |" >> metrics.md
          echo "|--------|----------------|-------------|" >> metrics.md
          echo "| Average CPU Usage | $AVG_CPU% | $MAIN_AVG_CPU% |" >> metrics.md
          echo "| Max CPU Usage | $MAX_CPU% | $MAIN_MAX_CPU% |" >> metrics.md
          echo "| Memory Usage | $MEMORY_USAGE MB | $MAIN_MEMORY_USAGE MB |" >> metrics.md

          echo "---" >> metrics.md

          cat metrics.md

      - name: Comment workflow status on Pull Request
        if: ${{ github.event_name == 'pull_request' }}
        uses: mshick/add-pr-comment@b8f338c590a895d50bcbfa6c5859251edc8952fc # v2.8.2 https://github.com/mshick/add-pr-comment/releases/tag/v2.8.2
        with:
          message-id: "workflow_status_${{ matrix.app.name }}"
          message-path: ${{ matrix.app.path }}/metrics.md
        continue-on-error: true

      # Stop all services
      - name: Stop all services
        if: always()
        working-directory: ${{ matrix.app.path }}
        run: |
          # Kill any remaining application process
          APP_PID=${{ steps.start_app.outputs.app_pid }}
          if [ -n "$APP_PID" ]; then
            kill $APP_PID 2>/dev/null || true
            sleep 2
            # Force kill if still running
            kill -9 $APP_PID 2>/dev/null || true
          fi
          # Kill any process on port 8000
          kill $(lsof -t -i :8000) 2>/dev/null || true
          # Stop dependencies
          uv run poe stop-deps || true
          # Clean up any remaining processes
          pkill -f "temporal.*${{ matrix.app.name }}" || true
          # Show app logs if they exist
          if [ -f app.log ]; then
            echo "Final application logs:"
            cat app.log
          fi

      - name: Commit scalene.json file
        if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/e2e' }}
        uses: stefanzweifel/git-auto-commit-action@b863ae1933cb653a53c021fe36dbb774e1fb9403 # v5.2.0 https://github.com/stefanzweifel/git-auto-commit-action/releases/tag/v5.2.0
        with:
          commit_message: "[skip ci] chore: update scalene-${{ matrix.app.name }}.json with latest performance metrics"
          file_pattern: "${{ matrix.app.path }}/.github/scalene-${{ matrix.app.name }}.json"
          commit_author: GitHub Actions <actions@github.com>
          skip_dirty_check: false
          push_options: "--force"