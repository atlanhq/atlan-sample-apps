<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Asset Description Reminder</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          sans-serif;
        background-color: #f8fafc;
        color: #1e293b;
        line-height: 1.6;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem;
      }

      .header {
        text-align: center;
        margin-bottom: 3rem;
      }

      .header h1 {
        font-size: 2.5rem;
        font-weight: 600;
        color: #0f172a;
        margin-bottom: 0.5rem;
      }

      .header p {
        font-size: 1.125rem;
        color: #64748b;
      }

      .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        border: 1px solid #e2e8f0;
        padding: 2rem;
        margin-bottom: 2rem;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-label {
        display: block;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 1rem;
        background-color: #ffffff;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
      }

      .form-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .form-help {
        font-size: 0.875rem;
        color: #64748b;
        margin-top: 0.25rem;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease-in-out;
        text-decoration: none;
        min-width: 150px;
      }

      .btn-primary {
        background-color: #3b82f6;
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        background-color: #2563eb;
      }

      .btn-primary:disabled {
        background-color: #9ca3af;
        cursor: not-allowed;
      }

      .loading {
        display: none;
        margin-left: 0.5rem;
      }

      .loading.show {
        display: inline-block;
      }

      .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .result {
        margin-top: 2rem;
        padding: 1rem;
        border-radius: 8px;
        display: none;
      }

      .result.success {
        background-color: #ecfdf5;
        border: 1px solid #10b981;
        color: #047857;
      }

      .result.error {
        background-color: #fef2f2;
        border: 1px solid #ef4444;
        color: #dc2626;
      }

      .result.show {
        display: block;
      }

      .step {
        display: none;
      }

      .step.active {
        display: block;
      }

      .step-header {
        display: flex;
        align-items: center;
        margin-bottom: 2rem;
      }

      .step-number {
        background-color: #3b82f6;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        font-size: 0.875rem;
      }

      .step-title {
        font-size: 1.25rem;
        font-weight: 500;
        color: #1e293b;
      }

      .btn-group {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
      }

      .btn-secondary {
        background-color: #e5e7eb;
        color: #374151;
      }

      .btn-secondary:hover:not(:disabled) {
        background-color: #d1d5db;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Asset Description Reminder</h1>
        <p>
          Send Slack reminders to users who have assets without descriptions
        </p>
      </div>

      <div class="card">
        <form id="reminderForm">
          <!-- Step 1: Credentials -->
          <div id="credentialsStep" class="step active">
            <div class="step-header">
              <div class="step-number">1</div>
              <div class="step-title">Enter Credentials</div>
            </div>

            <div class="form-group">
              <label class="form-label" for="baseUrl">Base URL</label>
              <input
                type="url"
                id="baseUrl"
                name="base_url"
                class="form-input"
                required
                placeholder="https://app.atlan.com"
              />
              <div class="form-help">Your Atlan instance URL</div>
            </div>

            <div class="form-group">
              <label class="form-label" for="atlanToken">Atlan Token</label>
              <input
                type="password"
                id="atlanToken"
                name="atlan_token"
                class="form-input"
                required
              />
              <div class="form-help">Your Atlan API token</div>
            </div>

            <div class="form-group">
              <label class="form-label" for="slackToken">Slack Bot Token</label>
              <input
                type="password"
                id="slackToken"
                name="slack_bot_token"
                class="form-input"
                required
              />
              <div class="form-help">Your Slack Bot User OAuth Token</div>
            </div>

            <div class="btn-group">
              <button type="button" class="btn btn-primary" id="nextStepBtn">
                Next
                <div class="loading" id="credentialsLoading">
                  <div class="spinner"></div>
                </div>
              </button>
            </div>
          </div>

          <!-- Step 2: User Selection and Options -->
          <div id="userStep" class="step">
            <div class="step-header">
              <div class="step-number">2</div>
              <div class="step-title">Select User & Options</div>
            </div>

            <div class="form-group">
              <label class="form-label" for="userSelect">Select User</label>
              <select
                id="userSelect"
                name="user_username"
                class="form-input"
                required
              >
                <option value="">Loading users...</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" for="assetLimit">Asset Limit</label>
              <input
                type="number"
                id="assetLimit"
                name="asset_limit"
                class="form-input"
                value="50"
                min="1"
                max="100"
              />
              <div class="form-help">
                Maximum number of assets to check (1-100)
              </div>
            </div>

            <div class="btn-group">
              <button type="button" class="btn btn-secondary" id="prevStepBtn">
                Back
              </button>
              <button
                type="submit"
                class="btn btn-primary"
                id="sendReminderBtn"
              >
                Send Reminder
                <div class="loading" id="loading">
                  <div class="spinner"></div>
                </div>
              </button>
            </div>
          </div>
        </form>

        <div id="result" class="result">
          <div id="resultContent"></div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("reminderForm");
        const credentialsStep = document.getElementById("credentialsStep");
        const userStep = document.getElementById("userStep");
        const nextStepBtn = document.getElementById("nextStepBtn");
        const prevStepBtn = document.getElementById("prevStepBtn");
        const userSelect = document.getElementById("userSelect");
        const sendReminderBtn = document.getElementById("sendReminderBtn");
        const loading = document.getElementById("loading");
        const credentialsLoading =
          document.getElementById("credentialsLoading");
        const result = document.getElementById("result");
        const resultContent = document.getElementById("resultContent");
        const baseUrlInput = document.getElementById("baseUrl");
        const atlanTokenInput = document.getElementById("atlanToken");
        const slackTokenInput = document.getElementById("slackToken");

        // Load saved configuration from localStorage
        const loadSavedConfig = () => {
          const savedConfig = localStorage.getItem("assetDescriptionConfig");
          if (savedConfig) {
            const config = JSON.parse(savedConfig);
            baseUrlInput.value = config.base_url || "";
          }
        };

        // Save configuration to localStorage
        const saveConfig = (config) => {
          localStorage.setItem(
            "assetDescriptionConfig",
            JSON.stringify({
              base_url: config.base_url,
            })
          );
        };

        // Validate credentials and move to next step
        nextStepBtn.addEventListener("click", async function () {
          const config = {
            base_url: baseUrlInput.value,
            atlan_token: atlanTokenInput.value,
            slack_bot_token: slackTokenInput.value,
          };

          if (
            !config.base_url ||
            !config.atlan_token ||
            !config.slack_bot_token
          ) {
            showResult("Please provide all required credentials", "error");
            return;
          }

          nextStepBtn.disabled = true;
          credentialsLoading.classList.add("show");
          result.classList.remove("show");

          try {
            await fetchUsers();
            credentialsStep.classList.remove("active");
            userStep.classList.add("active");
            saveConfig({
              base_url: config.base_url,
            });
          } catch (error) {
            showResult(
              "Failed to validate credentials: " + error.message,
              "error"
            );
          } finally {
            nextStepBtn.disabled = false;
            credentialsLoading.classList.remove("show");
          }
        });

        // Go back to credentials step
        prevStepBtn.addEventListener("click", function () {
          userStep.classList.remove("active");
          credentialsStep.classList.add("active");
          result.classList.remove("show");
        });

        // Fetch users for the dropdown
        async function fetchUsers() {
          try {
            const config = {
              base_url: baseUrlInput.value,
              atlan_token: atlanTokenInput.value,
              slack_bot_token: slackTokenInput.value,
            };

            const response = await fetch("/workflows/v1/users", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(config),
            });

            const data = await response.json();

            if (data.success && data.users) {
              userSelect.innerHTML =
                "<option value=''>Select a user...</option>" +
                data.users
                  .map(
                    (user) =>
                      `<option value="${user.username}">${
                        user.displayName || user.username
                      }</option>`
                  )
                  .join("");
            } else {
              throw new Error(data.error || "Failed to fetch users");
            }
          } catch (error) {
            console.error("Error fetching users:", error);
            userSelect.innerHTML =
              "<option value=''>Error loading users</option>";
            throw error;
          }
        }

        // Handle form submission
        form.addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData(form);
          const config = {
            base_url: formData.get("base_url"),
            atlan_token: formData.get("atlan_token"),
            slack_bot_token: formData.get("slack_bot_token"),
          };

          const request = {
            body: {
              config: config,
              user_username: formData.get("user_username"),
              asset_limit: parseInt(formData.get("asset_limit"), 10),
            },
          };

          if (!request.body.user_username) {
            showResult("Please select a user", "error");
            return;
          }

          sendReminderBtn.disabled = true;
          loading.classList.add("show");
          result.classList.remove("show", "success", "error");

          try {
            const response = await fetch("/workflows/v1/start", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(request),
            });

            const data = await response.json();

            if (data.success) {
              const result = data.workflow_result;
              showResult(
                `Success! Checked ${result.assets_checked} assets and sent ${result.reminders_sent} reminders.`,
                "success"
              );
            } else {
              showResult(data.error || "Failed to send reminder", "error");
            }
          } catch (error) {
            console.error("Error:", error);
            showResult("Failed to send reminder: " + error.message, "error");
          } finally {
            sendReminderBtn.disabled = false;
            loading.classList.remove("show");
          }
        });

        function showResult(message, type) {
          resultContent.textContent = message;
          result.className = `result ${type} show`;
        }

        // Initialize
        loadSavedConfig();
      });
    </script>
  </body>
</html>
